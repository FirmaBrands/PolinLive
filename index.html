<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firma Font | Polin Live</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="module">
        import { VideoEncoder } from "https://cdn.jsdelivr.net/npm/mediabunny@latest/dist/index.js";
        window.MediabunnyEncoder = VideoEncoder;
    </script>
    
    <style>
        :root {
            --bg-app: #09090b;       
            --bg-panel: #18181b;     
            --bg-header: #27272a;    
            --bg-input: #09090b;     
            --bg-input-hover: #27272a;
            --border: #3f3f46;
            --primary: #FF0054;      
            --primary-hover: #ff3377;
            --accent: #FF3924;       
            --selection: #FF0054;    
            --text-main: #e4e4e7;
            --text-muted: #a1a1aa;
            --font-ui: 'Inter', -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --radius-sm: 4px;
            --radius-md: 6px;
        }

        * { box-sizing: border-box; outline: none; user-select: none; }
        body {
            background: var(--bg-app); color: var(--text-main); font-family: var(--font-ui);
            height: 100vh; overflow: hidden; display: grid; grid-template-columns: 280px 1fr 300px; margin: 0; font-size: 12px;
        }

        /* --- UI COMPONENTS --- */
        aside { background: var(--bg-panel); border-right: 1px solid var(--border); border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; z-index: 10; }
        .panel-header { padding: 0 16px; height: 48px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: var(--bg-panel); }
        .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 13px; color: #fff; }
        .brand-logo-container { width: 24px; height: 24px; background: #000; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .brand-logo-container svg { width: 14px; fill: #fff; }
        .panel-content { padding: 20px; display: flex; flex-direction: column; gap: 24px; }
        .section-title { font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }

        textarea { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: #fff; padding: 12px; font-size: 16px; border-radius: var(--radius-md); resize: vertical; min-height: 80px; }
        .control-row { display: grid; grid-template-columns: 80px 1fr 45px; align-items: center; gap: 10px; min-height: 28px; }
        .num-input { width: 100%; background: transparent; border: 1px solid transparent; color: #fff; font-family: var(--font-mono); font-size: 11px; text-align: right; }
        
        .color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .swatch { aspect-ratio: 1.4; border-radius: 4px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }
        .swatch.active { border-color: #fff; box-shadow: 0 0 0 2px var(--primary); }
        .swatch-wide { width: 100%; height: 32px; border-radius: 4px; cursor: pointer; border: 1px solid #444; display: flex; align-items: center; justify-content: center; background: #1a1a1a; margin-bottom: 8px; font-weight: 700; font-size: 10px; }
        .swatch-wide.active { border-color: var(--primary); color: var(--primary); }

        .btn { width: 100%; height: 32px; font-size: 11px; font-weight: 600; border-radius: var(--radius-sm); cursor: pointer; background: var(--bg-header); border: 1px solid var(--border); color: #fff; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); border: none; }
        .btn-rec.recording { background: var(--accent); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .seg-control { background: var(--bg-input); border: 1px solid var(--border); border-radius: 4px; display: flex; padding: 2px; }
        .seg-btn { flex: 1; border: none; background: transparent; color: var(--text-muted); font-size: 9px; font-weight: 700; padding: 6px; cursor: pointer; border-radius: 2px; }
        .seg-btn.active { background: var(--bg-panel); color: #fff; }

        main { flex: 1; background: #050505; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #canvas-wrapper { border: 1px solid #333; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        #canvas-wrapper.transparent-bg { background-image: linear-gradient(45deg, #222 25%, transparent 25%), linear-gradient(-45deg, #222 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #222 75%), linear-gradient(-45deg, transparent 75%, #222 75%); background-size: 20px 20px; }

        #panel-letter { display: none; }
        body.has-selection #panel-global { display: none; }
        body.has-selection #panel-letter { display: flex; }
        
        #zipProgressWrapper { width: 100%; height: 4px; background: #222; margin-top: 10px; display: none; border-radius: 2px; overflow: hidden; }
        #zipBar { width: 0%; height: 100%; background: var(--primary); transition: width 0.1s; }
    </style>
</head>
<body class="has-selection">

    <aside>
        <div class="panel-header">
            <div class="brand"><div class="brand-logo-container"><svg viewBox="0 0 502 447"><polygon points="252.68 283.12 364.65 283.12 411.29 186.87 206.77 186.87 163.53 96.26 455.18 96.26 501.78 0 0 0 212.97 446.31 330.54 446.31 252.68 283.12"/></svg></div> FIRMA<span>FONT</span></div>
        </div>
        <div class="panel-content">
            <div class="section-group">
                <div class="section-title">Source</div>
                <textarea id="inpText" spellcheck="false">FIRMA סטודיו
2025</textarea>
            </div>
            <div class="section-group">
                <div class="section-title">Appearance</div>
                <div class="color-grid" id="gridTextColor">
                    <div class="swatch" data-color="#FFFFFF" style="background:#fff"></div>
                    <div class="swatch" data-color="#FF0054" style="background:#FF0054"></div>
                    <div class="swatch" data-color="#DFF946" style="background:#DFF946"></div>
                    <div class="swatch" data-color="#000000" style="background:#000"></div>
                </div>
                <div id="bgSwatchTrans" class="swatch-wide" onclick="setBgMode('transparent')">TRANSPARENT</div>
            </div>
        </div>
    </aside>

    <main id="viewport">
        <div id="canvas-wrapper">
            <canvas id="exportCanvas" width="1920" height="1080"></canvas>
        </div>
    </main>

    <aside>
        <div id="panel-global">
            <div class="panel-header"><div>SCENE</div></div>
            <div class="panel-content">
                <div class="section-group">
                    <div class="section-title">Engine</div>
                    <div class="control-row"><span>Speed</span><input type="range" id="slFps" min="1" max="60" value="24"><input type="number" id="numFps" class="num-input" value="24"></div>
                </div>
                <div style="flex:1"></div>
                <div class="section-group">
                    <div class="section-title">Export</div>
                    <div class="seg-control">
                        <button class="seg-btn active" onclick="setFormat('zip')">PNG SEQ</button>
                        <button class="seg-btn" onclick="setFormat('mov')">MOV PRORES</button>
                    </div>
                    <button id="btnRecord" class="btn btn-primary btn-rec" onclick="toggleRecording()">START RECORDING</button>
                    <div id="recStatus" style="text-align:center; font-size:10px; margin-top:8px; opacity:0.6;"></div>
                    <div id="zipProgressWrapper"><div id="zipBar"></div></div>
                </div>
            </div>
        </div>
    </aside>

<script>
const FONT_NAME = 'Firma';
const FONT_URL = 'Firma.otf';

const app = {
    rawText: "FIRMA סטודיו\n2025", textColor: '#ffffff', fontSize: 150, tracking: 0, lineHeight: 1.0,
    width: 1920, height: 1080, fps: 24, exportFormat: 'zip', bgMode: 'transparent', bgColor: '#000',
    isRecording: false, sequenceFrames: [], lastTime: 0, nodes: [], selectionIndex: -1,
    charMap: { 'A': ['ss01','ss02'], 'F': ['ss01','ss03'], 'א': ['ss01'] }
};

const dom = {
    input: document.getElementById('inpText'),
    canvas: document.getElementById('exportCanvas'),
    ctx: document.getElementById('exportCanvas').getContext('2d', { alpha: true }),
    btnRecord: document.getElementById('btnRecord'),
    recStatus: document.getElementById('recStatus'),
    zipBar: document.getElementById('zipBar'),
    zipProgressWrapper: document.getElementById('zipProgressWrapper')
};

async function init() {
    try { const font = new FontFace(FONT_NAME, `url(${FONT_URL})`); await font.load(); document.fonts.add(font); } catch(e){}
    syncText(); requestAnimationFrame(loop);
}

// --- MEDIABUNNY EXPORT LOGIC ---
async function renderMOV() {
    if (!window.MediabunnyEncoder) { alert("Encoder library loading..."); return; }
    
    dom.recStatus.textContent = "INITIALIZING HARDWARE ENCODER...";
    dom.zipProgressWrapper.style.display = "block";

    try {
        const encoder = new window.MediabunnyEncoder({
            width: app.width, height: app.height, fps: app.fps,
            codec: 'avc1.4d002a', // H.264 High Profile
            alpha: true // Enable transparency
        });

        for (let i = 0; i < app.sequenceFrames.length; i++) {
            const img = await createImageBitmap(app.sequenceFrames[i]);
            await encoder.addFrame(img);
            dom.zipBar.style.width = ((i / app.sequenceFrames.length) * 100) + "%";
        }

        const blob = await encoder.export();
        saveAs(blob, `Firma_Alpha_${Date.now()}.mov`);
    } catch(e) { console.error(e); alert("Export failed. Use Chrome/Safari on Mac."); }

    dom.recStatus.textContent = "DONE";
    setTimeout(() => dom.zipProgressWrapper.style.display = "none", 2000);
}

function syncText() {
    app.nodes = Array.from(app.rawText).map(char => ({
        originalChar: char, activeTag: null, timer: 0, glyphPool: [null, ...(app.charMap[char]||[])]
    }));
}

function toggleRecording() {
    if (app.isRecording) {
        app.isRecording = false;
        dom.btnRecord.textContent = "START RECORDING";
        app.exportFormat === 'zip' ? finalizeZip() : renderMOV();
    } else {
        app.isRecording = true;
        app.sequenceFrames = [];
        dom.btnRecord.textContent = "STOP RECORDING";
        dom.btnRecord.classList.add('recording');
    }
}

function finalizeZip() {
    dom.recStatus.textContent = "ZIPPING...";
    dom.zipProgressWrapper.style.display = "block";
    const zip = new JSZip();
    app.sequenceFrames.forEach((b, i) => zip.file(`frame_${i}.png`, b));
    zip.generateAsync({type:"blob"}, m => dom.zipBar.style.width = m.percent+"%").then(c => {
        saveAs(c, "sequence.zip");
        dom.zipProgressWrapper.style.display = "none";
    });
}

function loop(t) {
    requestAnimationFrame(loop);
    if(t - app.lastTime < (1000/app.fps)) return;
    app.lastTime = t;
    
    const ctx = dom.ctx;
    ctx.clearRect(0,0,app.width,app.height);
    ctx.font = `${app.fontSize}px ${FONT_NAME}`;
    ctx.fillStyle = app.textColor;
    ctx.textAlign = "center";
    ctx.fillText(app.rawText, app.width/2, app.height/2);

    if (app.isRecording) {
        dom.canvas.toBlob(b => app.sequenceFrames.push(b));
        dom.recStatus.textContent = `CAPTURED: ${app.sequenceFrames.length}`;
    }
}

function setFormat(f) { app.exportFormat = f; }
function setBgMode(m) { app.bgMode = m; document.getElementById('canvas-wrapper').className = m === 'transparent' ? 'transparent-bg' : ''; }

dom.input.oninput = e => { app.rawText = e.target.value; syncText(); };

init();
</script>
</body>
</html>
