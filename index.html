<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firma Font | Polin Live</title>
    
    <script src="coi-serviceworker.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/mediabunny@1.0.1/dist/index.bundle.min.js"></script>
    
    <style>
        :root {
            --bg-app: #09090b; --bg-panel: #18181b; --bg-header: #27272a; --bg-input: #09090b;
            --border: #3f3f46; --primary: #FF0054; --text-main: #e4e4e7; --text-muted: #a1a1aa;
            --font-ui: 'Inter', sans-serif; --radius-sm: 4px;
        }
        * { box-sizing: border-box; outline: none; user-select: none; }
        body { background: var(--bg-app); color: var(--text-main); font-family: var(--font-ui); height: 100vh; overflow: hidden; display: grid; grid-template-columns: 280px 1fr 300px; margin: 0; font-size: 12px; }
        main { position: relative; background: #050505; display: flex; flex-direction: column; overflow: hidden; }
        .viewport { flex: 1; display: flex; align-items: center; justify-content: center; background-image: radial-gradient(#333 1px, transparent 1px); background-size: 24px 24px; }
        #canvas-wrapper { box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid #333; background: #000; }
        #canvas-wrapper.transparent-bg { background-color: #333; background-image: linear-gradient(45deg, #444 25%, transparent 25%), linear-gradient(-45deg, #444 25%, transparent 25%); background-size: 20px 20px; }
        aside { background: var(--bg-panel); border-right: 1px solid var(--border); border-left: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; }
        .btn { width: 100%; height: 32px; cursor: pointer; background: var(--bg-header); border: 1px solid var(--border); color: var(--text-main); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-rec.recording { background: #FF3924; color: white; }
        #zipProgressWrapper { width: 100%; height: 4px; background: #222; margin-top: 12px; display: none; }
        #zipBar { width: 0%; height: 100%; background: var(--primary); }
    </style>
</head>
<body>

    <aside>
        <div style="font-weight:700; font-size:13px; margin-bottom:20px;">FIRMA<span>FONT</span></div>
        <textarea id="inpText" style="width:100%; min-height:80px; background:#000; color:#fff; border:1px solid #333; padding:10px;">FIRMA סטודיו</textarea>
    </aside>

    <main>
        <div class="viewport">
            <div id="canvas-wrapper" class="transparent-bg">
                <canvas id="exportCanvas" width="1920" height="1080"></canvas>
            </div>
        </div>
    </main>

    <aside>
        <div style="margin-top:auto;">
            <button id="btnFmtMov" class="btn" onclick="setExportFormat('mov')" style="margin-bottom:10px;">PREP PRORES MOV</button>
            <button id="btnRecord" class="btn btn-rec" onclick="toggleRecording()">REC SEQUENCE</button>
            <div id="recStatus" style="text-align:center; margin-top:10px; font-family:monospace; font-size:10px;"></div>
            <div id="zipProgressWrapper"><div id="zipBar"></div></div>
        </div>
    </aside>

<script>
const FONT_NAME = 'Firma';
const app = {
    fps: 24, exportFormat: 'zip', sequenceFrames: [], isRecording: false,
    bunny: null, ffmpegLoaded: false, lastTime: 0
};

const dom = {
    canvas: document.getElementById('exportCanvas'),
    ctx: document.getElementById('exportCanvas').getContext('2d'),
    recStatus: document.getElementById('recStatus'),
    zipBar: document.getElementById('zipBar'),
    zipProgressWrapper: document.getElementById('zipProgressWrapper')
};

async function initFFmpeg() {
    if (app.bunny) return;
    dom.recStatus.textContent = "INITIALIZING ENGINE...";
    try {
        // Now that the script loads, this will no longer throw a ReferenceError
        app.bunny = new MediaBunny();
        await app.bunny.init();
        app.ffmpegLoaded = true;
        dom.recStatus.textContent = "ENGINE READY";
    } catch (err) {
        console.error(err);
        dom.recStatus.textContent = "ENGINE INIT FAILED";
    }
}

async function renderProRes() {
    if (!app.ffmpegLoaded) await initFFmpeg();
    dom.recStatus.textContent = "ENCODING PRORES 4444...";
    dom.zipProgressWrapper.style.display = "block";
    try {
        const videoBlob = await app.bunny.export(app.sequenceFrames, {
            format: 'mov', fps: app.fps,
            args: ['-c:v', 'prores_ks', '-profile:v', '44', '-pix_fmt', 'yuva444p10le']
        });
        dom.zipBar.style.width = "100%";
        saveAs(videoBlob, `Firma_Alpha_${Date.now()}.mov`);
        dom.recStatus.textContent = "DONE";
    } catch (err) {
        console.error(err);
        dom.recStatus.textContent = "ENCODING ERROR";
    }
}

function toggleRecording() {
    if(app.isRecording) {
        app.isRecording = false;
        if (app.exportFormat === 'zip') finalizeZip(); else renderProRes();
    } else {
        app.sequenceFrames = [];
        app.isRecording = true;
        dom.recStatus.textContent = "CAPTURING...";
    }
}

function setExportFormat(fmt) { app.exportFormat = fmt; if(fmt === 'mov') initFFmpeg(); }

function loop(t) {
    requestAnimationFrame(loop);
    if(t - app.lastTime > 1000/app.fps) {
        app.lastTime = t;
        render();
        if(app.isRecording) {
            dom.canvas.toBlob(b => { app.sequenceFrames.push(b); dom.recStatus.textContent = `FRAMES: ${app.sequenceFrames.length}`; }, 'image/png');
        }
    }
}

function render() {
    const ctx = dom.ctx;
    ctx.clearRect(0, 0, 1920, 1080);
    ctx.fillStyle = "#FF0054";
    ctx.font = "150px sans-serif";
    ctx.textAlign = "center";
    ctx.fillText(document.getElementById('inpText').value, 960, 540);
}

lucide.createIcons();
loop(0);
</script>
</body>
</html>
