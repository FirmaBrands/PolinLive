<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firma Alpha Pro | Polin Live</title>
    
    <script src="coi-serviceworker.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

    <style>
        :root {
            --bg-app: #09090b; --bg-panel: #18181b; --bg-header: #27272a; --bg-input: #09090b;
            --border: #3f3f46; --primary: #FF0054; --text-main: #e4e4e7;
            --font-ui: 'Inter', sans-serif; --font-mono: 'JetBrains Mono', monospace;
        }
        * { box-sizing: border-box; outline: none; user-select: none; }
        body { background: var(--bg-app); color: var(--text-main); font-family: var(--font-ui); height: 100vh; overflow: hidden; display: grid; grid-template-columns: 280px 1fr 300px; margin: 0; font-size: 12px; }
        
        aside { background: var(--bg-panel); border-left: 1px solid var(--border); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; }
        .panel-header { height: 48px; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 16px; background: var(--bg-panel); font-weight: 700; color: #fff; }
        .panel-content { padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        .section-title { font-size: 11px; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; color: #888; }
        
        textarea { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: #fff; padding: 12px; font-family: 'Firma', var(--font-mono); font-size: 24px; border-radius: 6px; resize: vertical; min-height: 80px; }

        /* THE STAGE */
        main { position: relative; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        
        /* The Wrapper handles the visual background (Checkerboard/Green) */
        #canvas-wrapper { 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
            border: 1px solid #333; 
            /* Default to checkerboard so you know it's transparent */
            background-color: #222;
            background-image: 
                linear-gradient(45deg, #333 25%, transparent 25%), 
                linear-gradient(-45deg, #333 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #333 75%), 
                linear-gradient(-45deg, transparent 75%, #333 75%);
            background-size: 20px 20px;
        }
        
        /* Green Screen Mode for verification */
        #canvas-wrapper.green-bg {
            background: #00FF00 !important;
            background-image: none !important;
        }

        .btn { width: 100%; height: 32px; cursor: pointer; background: var(--bg-header); border: 1px solid var(--border); color: #fff; border-radius: 4px; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 600; font-size: 11px; transition: 0.2s; }
        .btn:hover { background: #333; }
        .btn-rec.recording { background: #FF3924; animation: pulse 2s infinite; border-color: #FF3924; }
        
        #recStatus { text-align: center; margin-top: 10px; font-family: var(--font-mono); font-size: 10px; color: #888; white-space: pre-wrap; }
        #zipBar { width: 0%; height: 4px; background: var(--primary); margin-top: 8px; transition: width 0.1s; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <aside>
        <div class="panel-header">FIRMA FONT</div>
        <div class="panel-content">
            <div>
                <div class="section-title">Source</div>
                <textarea id="inpText">FIRMA סטודיו</textarea>
            </div>
            
            <div>
                 <div class="section-title">Verify Transparency</div>
                 <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                     <button class="btn" onclick="toggleBg(false)">Checkerboard</button>
                     <button class="btn" onclick="toggleBg(true)" style="background:#004400; color:#4f4;">Green Screen</button>
                 </div>
                 <p style="font-size:10px; color:#666; margin-top:8px; line-height:1.4;">
                     If you see the checkerboard or green through the text, the file <b>will</b> have an alpha channel. <br><br>
                     <span style="color:#FF3924;">Note: Video players (QuickTime/VLC) will show black. Import to After Effects to see transparency.</span>
                 </p>
            </div>
        </div>
    </aside>

    <main>
        <div id="canvas-wrapper">
            <canvas id="exportCanvas" width="1920" height="1080"></canvas>
        </div>
    </main>

    <aside>
        <div class="panel-header">EXPORT</div>
        <div class="panel-content">
            <div>
                <div class="section-title">Output</div>
                <button class="btn" id="btnRec" onclick="toggleRecording()">
                    <i data-lucide="video" width="14"></i> RECORD PRORES 4444
                </button>
                <div id="recStatus"></div>
                <div id="zipBar"></div>
            </div>
        </div>
    </aside>

<script>
const app = {
    fps: 24, 
    sequenceFrames: [], 
    isRecording: false, 
    ffmpeg: null, 
    width: 1920, height: 1080,
    lastTime: 0
};

const dom = {
    canvas: document.getElementById('exportCanvas'),
    // CRITICAL: Explicitly request alpha channel
    ctx: document.getElementById('exportCanvas').getContext('2d', { alpha: true }),
    recStatus: document.getElementById('recStatus'),
    zipBar: document.getElementById('zipBar'),
    inpText: document.getElementById('inpText'),
    wrapper: document.getElementById('canvas-wrapper')
};

function toggleBg(isGreen) {
    if(isGreen) dom.wrapper.classList.add('green-bg');
    else dom.wrapper.classList.remove('green-bg');
}

// --- FFmpeg Logic ---
async function loadFFmpeg() {
    if (app.ffmpeg && app.ffmpeg.isLoaded()) return;
    dom.recStatus.textContent = "LOADING ENGINE...";
    try {
        const { createFFmpeg } = FFmpeg;
        app.ffmpeg = createFFmpeg({ 
            log: true,
            corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js'
        });
        await app.ffmpeg.load();
        dom.recStatus.textContent = "ENGINE READY";
    } catch (e) {
        console.error(e);
        dom.recStatus.textContent = "LOAD FAILED.";
    }
}

async function exportProRes() {
    if (!app.ffmpeg || !app.ffmpeg.isLoaded()) await loadFFmpeg();
    dom.recStatus.textContent = "WRITING FILES...";
    
    const { fetchFile } = FFmpeg;
    
    for (let i = 0; i < app.sequenceFrames.length; i++) {
        const fname = `frame${String(i).padStart(4, '0')}.png`;
        app.ffmpeg.FS('writeFile', fname, await fetchFile(app.sequenceFrames[i]));
        dom.zipBar.style.width = `${(i/app.sequenceFrames.length)*40}%`;
    }
    
    dom.recStatus.textContent = "ENCODING PRORES...";
    
    // Explicit ProRes 4444 with Alpha
    await app.ffmpeg.run(
        '-framerate', String(app.fps),
        '-pattern_type', 'glob', '-i', '*.png',
        '-c:v', 'prores_ks', 
        '-profile:v', '4444', 
        '-pix_fmt', 'yuva444p10le', 
        '-vendor', 'apl0',
        '-y', 'output.mov'
    );
    
    dom.zipBar.style.width = '100%';
    const data = app.ffmpeg.FS('readFile', 'output.mov');
    saveAs(new Blob([data.buffer], { type: 'video/quicktime' }), `Firma_Alpha_${Date.now()}.mov`);
    
    // Cleanup
    try {
        app.ffmpeg.FS('unlink', 'output.mov');
        for (let i = 0; i < app.sequenceFrames.length; i++) {
             app.ffmpeg.FS('unlink', `frame${String(i).padStart(4, '0')}.png`);
        }
    } catch(e) {}
    
    dom.recStatus.textContent = "DONE";
    setTimeout(() => { dom.zipBar.style.width = '0%'; }, 2000);
}

// --- Loop ---
function toggleRecording() {
    if (app.isRecording) {
        app.isRecording = false;
        document.getElementById('btnRec').classList.remove('recording');
        document.getElementById('btnRec').innerHTML = `<i data-lucide="video" width="14"></i> RECORD PRORES 4444`;
        exportProRes();
    } else {
        if (!crossOriginIsolated) { alert("Service Worker Missing! Check Console."); return; }
        app.sequenceFrames = [];
        app.isRecording = true;
        document.getElementById('btnRec').classList.add('recording');
        document.getElementById('btnRec').innerHTML = "STOP RECORDING";
        dom.recStatus.textContent = "CAPTURING...";
        loadFFmpeg();
    }
}

function loop(t) {
    requestAnimationFrame(loop);
    if (t - app.lastTime < 1000 / app.fps) return;
    app.lastTime = t;
    render();
    if (app.isRecording) {
        // PNG preserves transparency
        dom.canvas.toBlob(b => app.sequenceFrames.push(b), 'image/png');
    }
}

function render() {
    // 1. ALWAYS CLEAR CANVAS - No black fill logic allowed here
    dom.ctx.clearRect(0, 0, app.width, app.height);
    
    // 2. Draw Text
    dom.ctx.fillStyle = "#FF0054";
    dom.ctx.font = "bold 150px Arial";
    dom.ctx.textAlign = "center";
    dom.ctx.textBaseline = "middle";
    dom.ctx.fillText(dom.inpText.value, app.width/2, app.height/2);
}

lucide.createIcons();
loop(0);
</script>
</body>
</html>
