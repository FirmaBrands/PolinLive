<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firma Font | Polin Live</title>
    
    <script src="coi-serviceworker.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    
    <style>
        :root {
            --bg-app: #09090b;       
            --bg-panel: #18181b;     
            --border: #3f3f46;
            --primary: #FF0054;      
            --accent: #FF3924;       
            --text-main: #e4e4e7;
            --text-muted: #a1a1aa;
            --font-ui: 'Inter', sans-serif;
            --radius-sm: 4px;
        }

        body {
            background: var(--bg-app);
            color: var(--text-main);
            font-family: var(--font-ui);
            height: 100vh;
            margin: 0;
            display: grid;
            grid-template-columns: 280px 1fr 300px;
            font-size: 12px;
            overflow: hidden;
        }

        aside { background: var(--bg-panel); border-right: 1px solid var(--border); border-left: 1px solid var(--border); padding: 20px; }
        main { background: #050505; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        
        #canvas-wrapper { border: 1px solid #333; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        #canvas-wrapper.transparent-bg {
            background-image: linear-gradient(45deg, #222 25%, transparent 25%), linear-gradient(-45deg, #222 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #222 75%), linear-gradient(-45deg, transparent 75%, #222 75%);
            background-size: 10px 10px;
        }

        .btn {
            width: 100%; padding: 10px; margin-top: 10px; cursor: pointer;
            background: var(--bg-app); border: 1px solid var(--border); color: #fff;
            border-radius: var(--radius-sm); font-weight: 600;
        }
        .btn-rec.recording { background: var(--accent); border-color: var(--accent); }
        .seg-control { display: flex; background: #000; padding: 2px; border-radius: 4px; }
        .seg-btn { flex: 1; border: none; background: transparent; color: #555; font-size: 10px; padding: 8px; cursor: pointer; }
        .seg-btn.active { background: var(--bg-panel); color: #fff; }

        #recStatus { text-align: center; margin-top: 10px; font-family: monospace; color: var(--primary); }
    </style>
</head>
<body>

    <aside>
        <h3>INPUT</h3>
        <textarea id="inpText" style="width:100%; height:100px; background:#000; color:#fff; border:1px solid #333;">FIRMA</textarea>
    </aside>

    <main>
        <div id="canvas-wrapper" class="transparent-bg">
            <canvas id="exportCanvas" width="1920" height="1080" style="max-width:100%; height:auto;"></canvas>
        </div>
    </main>

    <aside>
        <h3>EXPORT</h3>
        <div class="seg-control">
            <button class="seg-btn active" id="btnFmtZip" onclick="setFormat('zip')">PNG SEQ</button>
            <button class="seg-btn" id="btnFmtMp4" onclick="setFormat('mp4')">MP4</button>
            <button class="seg-btn" id="btnFmtMov" onclick="setFormat('mov')">MOV (ALPHA)</button>
        </div>
        <button id="btnRecord" class="btn btn-rec">START RECORDING</button>
        <div id="recStatus"></div>
    </aside>

<script>
const { createFFmpeg, fetchFile } = FFmpeg;
const ffmpeg = createFFmpeg({ log: true });

const state = {
    isRecording: false,
    frames: [],
    format: 'zip',
    fps: 24
};

const dom = {
    canvas: document.getElementById('exportCanvas'),
    ctx: document.getElementById('exportCanvas').getContext('2d', { alpha: true }),
    status: document.getElementById('recStatus'),
    btn: document.getElementById('btnRecord')
};

function setFormat(f) {
    state.format = f;
    document.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`btnFmt${f.charAt(0).toUpperCase() + f.slice(1)}`).classList.add('active');
}

dom.btn.onclick = async () => {
    if (state.isRecording) {
        state.isRecording = false;
        dom.btn.textContent = "PROCESSING...";
        if (state.format === 'mov') await exportMov();
        else if (state.format === 'zip') await exportZip();
        dom.btn.textContent = "START RECORDING";
        dom.status.textContent = "";
    } else {
        state.frames = [];
        state.isRecording = true;
        dom.btn.textContent = "STOP RECORDING";
        dom.btn.classList.add('recording');
    }
};

async function exportMov() {
    dom.status.textContent = "LOADING FFMPEG...";
    if (!ffmpeg.isLoaded()) await ffmpeg.load();

    dom.status.textContent = "WRITING FRAMES...";
    for (let i = 0; i < state.frames.length; i++) {
        const name = `f${i.toString().padStart(4, '0')}.png`;
        ffmpeg.FS('writeFile', name, await fetchFile(state.frames[i]));
    }

    dom.status.textContent = "ENCODING PRORES 4444...";
    // The specific command for ProRes 4444 with Alpha Channel
    await ffmpeg.run(
        '-framerate', `${state.fps}`,
        '-i', 'f%04d.png',
        '-c:v', 'prores_ks',
        '-profile:v', '4', // 4 = ProRes 4444
        '-pix_fmt', 'yuva444p10le', // Alpha support
        'output.mov'
    );

    const data = ffmpeg.FS('readFile', 'output.mov');
    saveAs(new Blob([data.buffer], { type: 'video/quicktime' }), `Firma_Alpha_${Date.now()}.mov`);
}

async function exportZip() {
    const zip = new JSZip();
    state.frames.forEach((b, i) => zip.file(`frame_${i}.png`, b));
    const content = await zip.generateAsync({type:"blob"});
    saveAs(content, "sequence.zip");
}

function loop() {
    const { ctx, canvas } = dom;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Draw simple glitch text for preview
    ctx.fillStyle = "#FF0054";
    ctx.font = "bold 200px sans-serif";
    ctx.textAlign = "center";
    ctx.fillText(document.getElementById('inpText').value, canvas.width/2, canvas.height/2 + 70);

    if (state.isRecording) {
        canvas.toBlob(b => state.frames.push(b), 'image/png');
        dom.status.textContent = `CAPTURED: ${state.frames.length}`;
    }
    requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
